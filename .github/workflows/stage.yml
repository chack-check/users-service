name: CI/CD Stage

on:
  push:
    branches: [ "main", "master" ]

jobs:
  staging:
    uses: chack-check/diffaction-workflows/.github/workflows/staging.yml@main
    with:
      service-name: diffaction-users-service
      app-dependencies-manifests: |
        kubernetes/stage/db/deployment.yml
        kubernetes/stage/db/service.yml
        kubernetes/stage/redis/deployment.yml
        kubernetes/stage/redis/service.yml
        kubernetes/stage/mailhog/deployment.yml
        kubernetes/stage/mailhog/service.yml
        kubernetes/stage/mailhog/ingress.yml
      app-manifests: |
        kubernetes/stage/app/deployment.yml
        kubernetes/stage/app/service.yml
        kubernetes/stage/app/ingress.yml
      run-tests-command: poetry run pytest
    secrets:
      KUBERNETES_SECRET: ${{ secrets.KUBERNETES_SECRET }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      CLIENT_SERVICE_PAT: ${{ secrets.CLIENT_SERVICE_PAT }}
